<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Turnos UPC</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Header UPC */
        .header { border-bottom: 4px solid #E30613; padding-bottom: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 900; color: #E30613; }
        .logo span { color: #333; font-weight: 400; }

        /* Upload */
        .upload-box { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; background: #fafafa; }
        .upload-box:hover { border-color: #E30613; background: #fff5f5; }
        .status { margin-top: 10px; font-size: 14px; font-weight: bold; }

        /* Search */
        .search-area { margin-top: 30px; display: none; }
        .input-group { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #E30613; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #c4040f; }

        /* Results */
        .result-card { margin-top: 30px; display: none; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .result-header { background: #333; color: white; padding: 15px 20px; }
        .result-body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .info-col h3 { color: #E30613; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0; }
        .info-col.gray h3 { color: #555; }
        
        .data-row { margin-bottom: 15px; }
        .label { font-size: 12px; color: #888; text-transform: uppercase; display: block; }
        .value { font-size: 18px; font-weight: 600; }

        .error { color: red; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">UPC <span>Buscador de Turnos</span></div>
        <div style="font-size: 12px; color: #888;">Verano 2026</div>
    </div>

    <div class="upload-box" onclick="document.getElementById('file').click()">
        <i class="fas fa-file-excel" style="font-size: 40px; color: #ccc; margin-bottom: 10px;"></i>
        <div>Clic aquí para subir el Excel</div>
        <div style="font-size: 12px; color: #888; margin-top: 5px;">(Turnos_Masivos_PH...)</div>
        <input type="file" id="file" accept=".xlsx, .csv" style="display:none">
    </div>
    <div id="status" class="status" style="text-align: center;"></div>

    <div id="search-section" class="search-area">
        <div class="input-group">
            <input type="text" id="code-input" placeholder="Ingrese Código Sócrates (ej: U20241F034)">
            <button onclick="buscar()">BUSCAR</button>
        </div>
        <div id="error-msg" class="error"></div>
    </div>

    <div id="result" class="result-card">
        <div class="result-header">
            <h2 style="margin:0; font-size: 20px;" id="res-name">Nombre Alumno</h2>
            <span style="font-size: 13px; opacity: 0.8;" id="res-codes">Códigos</span>
        </div>
        <div class="result-body">
            
            <div class="info-col">
                <h3><i class="fas fa-calendar-check"></i> MATRÍCULA REGULAR</h3>
                <div class="data-row">
                    <span class="label">Grupo / Prioridad</span>
                    <span class="value" id="res-mat-grupo" style="color:#E30613">TURNO X</span>
                </div>
                <div class="data-row">
                    <span class="label">Fecha y Hora</span>
                    <span class="value" id="res-mat-fecha">-</span>
                </div>
            </div>

            <div class="info-col gray">
                <h3><i class="fas fa-clock"></i> PLANIFICACIÓN HORARIA</h3>
                <div class="data-row">
                    <span class="label">Turno PH</span>
                    <span class="value" id="res-ph-turno">1</span>
                </div>
                <div class="data-row">
                    <span class="label">Fecha y Hora</span>
                    <span class="value" id="res-ph-fecha">-</span>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let BD = {}; // Aquí guardaremos los datos limpios

    document.getElementById('file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        document.getElementById('status').innerText = "Leyendo archivo...";
        document.getElementById('status').style.color = "blue";

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Buscar en TODAS las hojas
                let procesado = false;
                workbook.SheetNames.forEach(sheetName => {
                    if(procesado) return;
                    
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    if(analizarHoja(rows)) procesado = true;
                });

                if(procesado) {
                    document.getElementById('status').innerText = "✓ Archivo cargado correctamente";
                    document.getElementById('status').style.color = "green";
                    document.getElementById('search-section').style.display = "block";
                } else {
                    throw new Error("No se encontró la columna 'Código Sócrates' o 'Banner'");
                }
            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "Error: " + err.message;
                document.getElementById('status').style.color = "red";
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function analizarHoja(rows) {
        // 1. Encontrar la fila de cabecera buscando "Socrates" y "Turno"
        let headerIdx = -1;
        for(let i=0; i<Math.min(rows.length, 50); i++) {
            const linea = JSON.stringify(rows[i]).toLowerCase();
            if(linea.includes("sócrates") || linea.includes("socrates")) {
                headerIdx = i;
                break;
            }
        }

        if(headerIdx === -1) return false;

        // 2. Mapear columnas (usamos nombres aproximados)
        const headers = rows[headerIdx].map(h => (h||"").toString().toLowerCase().trim());
        
        const colSocrates = headers.findIndex(h => h.includes("sócrates") || h.includes("socrates"));
        const colBanner = headers.findIndex(h => h.includes("banner"));
        const colNombre = headers.findIndex(h => h.includes("nombres"));
        const colPaterno = headers.findIndex(h => h.includes("paterno"));
        const colMaterno = headers.findIndex(h => h.includes("materno"));

        // Lógica de vecinos:
        // Buscamos "Turno" (para PH). Sus vecinos son +1 (Día) y +2 (Hora)
        const colTurnoPH = headers.indexOf("turno");
        
        // Buscamos "GRUPO" (para Matrícula). Sus vecinos son +1 (Día) y +2 (Hora)
        const colGrupoMat = headers.findIndex(h => h === "grupo");

        if(colSocrates === -1 || colTurnoPH === -1) return false;

        // 3. Extraer datos
        BD = {};
        for(let i = headerIdx + 1; i < rows.length; i++) {
            const row = rows[i];
            if(!row) continue;

            const codS = (row[colSocrates] || "").toString().trim().toUpperCase();
            const codB = colBanner > -1 ? (row[colBanner] || "").toString().trim().toUpperCase() : "";

            if(codS.length > 3 || codB.length > 3) {
                // Nombre completo
                const nom = (row[colNombre] || "") + " " + (row[colPaterno] || "") + " " + (row[colMaterno] || "");
                
                // Datos PH
                const ph_turno = row[colTurnoPH];
                const ph_dia = row[colTurnoPH + 1];
                const ph_hora = row[colTurnoPH + 2];

                // Datos Matrícula
                const mat_grupo = colGrupoMat > -1 ? row[colGrupoMat] : "-";
                const mat_dia = colGrupoMat > -1 ? row[colGrupoMat + 1] : "-";
                const mat_hora = colGrupoMat > -1 ? row[colGrupoMat + 2] : "-";

                const obj = {
                    nombre: nom,
                    codigos: `${codS} / ${codB}`,
                    ph: { t: ph_turno, f: formatearFecha(ph_dia), h: formatearHora(ph_hora) },
                    mat: { g: mat_grupo, f: formatearFecha(mat_dia), h: formatearHora(mat_hora) }
                };

                if(codS) BD[codS] = obj;
                if(codB) BD[codB] = obj;
            }
        }
        return true;
    }

    function buscar() {
        const codigo = document.getElementById('code-input').value.trim().toUpperCase();
        const data = BD[codigo];
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error-msg');

        if(data) {
            document.getElementById('res-name').innerText = data.nombre;
            document.getElementById('res-codes').innerText = data.codigos;
            
            // Matrícula
            document.getElementById('res-mat-grupo').innerText = data.mat.g || "-";
            document.getElementById('res-mat-fecha').innerText = (data.mat.f || "-") + " " + (data.mat.h || "");
            
            // PH
            document.getElementById('res-ph-turno').innerText = data.ph.t || "-";
            document.getElementById('res-ph-fecha').innerText = (data.ph.f || "-") + " " + (data.ph.h || "");

            resultDiv.style.display = "block";
            errorDiv.style.display = "none";
        } else {
            resultDiv.style.display = "none";
            errorDiv.style.display = "block";
            errorDiv.innerText = "No se encontró información para el código: " + codigo;
        }
    }

    // Helpers para limpiar fechas de Excel
    function formatearFecha(val) {
        if(!val) return "";
        if(String(val).includes("/")) return val; // Ya es texto
        if(!isNaN(val)) {
            const date = XLSX.SSF.parse_date_code(val);
            return `${date.d}/${date.m}/${date.y}`;
        }
        return val;
    }

    function formatearHora(val) {
        if(!val) return "";
        if(String(val).includes(":")) return val;
        if(typeof val === 'number') {
            const totalSeconds = Math.floor(val * 86400);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:00`;
        }
        return val;
    }
</script>

</body>
</html>
